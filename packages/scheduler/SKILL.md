---
name: task-scheduler
description: Scheduled task manager triggering morning greetings (8:00), evening reviews (22:00), and anomaly detection (23:59). Uses node-cron for scheduling and Bull queue for reliable task execution with retry mechanisms. Use when automating periodic tasks, sending push notifications, or monitoring user learning patterns.
metadata:
  category: scheduler
  version: 1.0.0
  priority: P0
  estimated-days: 2
  triggers: "schedule, cron,å®šæ—¶ä»»åŠ¡, è°ƒåº¦, æ—©å®‰é—®å€™, æ™šé—´å¤ç›˜"
  dependencies: ["core", "agent-langgraph"]
  dependents: []
allowed-tools: Read Write Edit Bash(pnpm:*:*) Bash(node:*:*)
---

# å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨æŠ€èƒ½æ–‡æ¡£

**æ¨¡å—ç±»å‹**: å®šæ—¶ä»»åŠ¡
**å¼€å‘çŠ¶æ€**: âœ… å·²å®Œæˆ
**ä¼˜å…ˆçº§**: P0
**é¢„è®¡å‘¨æœŸ**: 2 å¤©

---

## ğŸ“– æ¨¡å—æ¦‚è¿°

å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨è´Ÿè´£åœ¨ç‰¹å®šæ—¶é—´è§¦å‘è‡ªåŠ¨ä»»åŠ¡ï¼Œå®ç°ä¸»åŠ¨é™ªä¼´åŠŸèƒ½ã€‚

**æ ¸å¿ƒåŠŸèƒ½**:
- æ—©å®‰é—®å€™ï¼ˆæ¯å¤© 8:00ï¼‰
- æ™šé—´å¤ç›˜ï¼ˆæ¯å¤© 22:00ï¼‰
- å¼‚å¸¸æ£€æµ‹ï¼ˆæ¯å¤© 23:59ï¼‰

**æŠ€æœ¯ç‰¹ç‚¹**:
- node-cron: å®šæ—¶ä»»åŠ¡è°ƒåº¦
- Bull: ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†
- å¤±è´¥é‡è¯•: ç¡®ä¿ä»»åŠ¡å¯é æ‰§è¡Œ

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### åŠŸèƒ½1: æ—©å®‰é—®å€™ä»»åŠ¡

**åŠŸèƒ½æè¿°**: æ¯å¤©æ—©ä¸Š 8:00 å‘ç”¨æˆ·å‘é€æ—©å®‰é—®å€™å’Œå­¦ä¹ å»ºè®®ã€‚

**è§¦å‘æ—¶é—´**: æ¯å¤©æ—©ä¸Š 8:00

**ä»»åŠ¡æµç¨‹**:
1. æŸ¥è¯¢æ‰€æœ‰æ´»è·ƒç”¨æˆ·
2. è°ƒç”¨ Agent ç”Ÿæˆä¸ªæ€§åŒ–é—®å€™
3. å‘é€æ¨é€é€šçŸ¥
4. ç­‰å¾…ç”¨æˆ·å¿«æ·å›å¤

**æ¶ˆæ¯å†…å®¹**:
- ä¸ªæ€§åŒ–é—®å€™ï¼ˆä½¿ç”¨ç”¨æˆ·æ˜µç§°ï¼‰
- ä»Šæ—¥å­¦ä¹ å»ºè®®ï¼ˆåŸºäºå­¦ä¹ è¿›åº¦ï¼‰
- é¼“åŠ±è¯­
- å¿«æ·å›å¤é€‰é¡¹

**å¿«æ·å›å¤**:
- "å¼€å§‹ä»Šå¤©çš„å­¦ä¹ " â†’ è¿›å…¥ä»»åŠ¡ç”Ÿæˆ
- "è°ƒæ•´å­¦ä¹ è®¡åˆ’" â†’ è¿›å…¥è®¡åˆ’è°ƒæ•´
- "æŸ¥çœ‹å­¦ä¹ è¿›åº¦" â†’ è¿›å…¥è¿›åº¦æŸ¥è¯¢

---

### åŠŸèƒ½2: æ™šé—´å¤ç›˜ä»»åŠ¡

**åŠŸèƒ½æè¿°**: æ¯å¤©æ™šä¸Š 22:00 å‘ç”¨æˆ·å‘é€ä»Šæ—¥å­¦ä¹ æ€»ç»“ã€‚

**è§¦å‘æ—¶é—´**: æ¯å¤©æ™šä¸Š 22:00

**ä»»åŠ¡æµç¨‹**:
1. æŸ¥è¯¢ç”¨æˆ·ä»Šæ—¥å­¦ä¹ æ•°æ®
2. ç”Ÿæˆæœ¬æ—¥å­¦ä¹ æŠ¥å‘Š
3. å‘é€æ¨é€é€šçŸ¥
4. å¼•å¯¼ç”¨æˆ·å¤ç›˜

**æŠ¥å‘Šå†…å®¹**:
- ä»Šæ—¥å­¦ä¹ æ—¶é•¿
- å®Œæˆé¢˜ç›®æ•°é‡
- å¹³å‡æ­£ç¡®ç‡
- è¿ç»­å­¦ä¹ å¤©æ•°
- ä»Šæ—¥æˆå°±ï¼ˆå¦‚æœ‰ï¼‰
- æ˜æ—¥å­¦ä¹ é¢„å‘Š

**å¿«æ·å›å¤**:
- "è®°å½•ä»Šå¤©çš„å­¦ä¹ å¿ƒå¾—" â†’ è®°å½•ç¬”è®°
- "æŸ¥çœ‹æœ¬å‘¨æ•°æ®" â†’ è·³è½¬æ•°æ®çœ‹æ¿
- "å‡†å¤‡ä¼‘æ¯" â†’ ç»“æŸå¯¹è¯

---

### åŠŸèƒ½3: å¼‚å¸¸æ£€æµ‹ä»»åŠ¡

**åŠŸèƒ½æè¿°**: æ¯å¤©æ·±å¤œæ£€æµ‹ç”¨æˆ·å­¦ä¹ å¼‚å¸¸ï¼ŒåŠæ—¶å¹²é¢„ã€‚

**è§¦å‘æ—¶é—´**: æ¯å¤©æ™šä¸Š 23:59

**æ£€æµ‹é¡¹**:
1. **è¿ç»­æœªå­¦ä¹ **: è¿ç»­3å¤©æœªå®Œæˆä»»ä½•å­¦ä¹ ä»»åŠ¡
2. **æ­£ç¡®ç‡ä¸‹é™**: æœ€è¿‘ä¸€å‘¨æ­£ç¡®ç‡ä¸‹é™è¶…è¿‡ 10%
3. **è¿›åº¦æ»å**: å­¦ä¹ è¿›åº¦è½åè®¡åˆ’è¶…è¿‡ 20%
4. **ä»»åŠ¡é€¾æœŸ**: æœ‰é€¾æœŸæœªå®Œæˆçš„ä»»åŠ¡

**å¹²é¢„ç­–ç•¥**:
- æ¸©å’Œæé†’ï¼ˆç¬¬ä¸€æ¬¡å¼‚å¸¸ï¼‰
- å…³æ€€è¯¢é—®ï¼ˆè¿ç»­å¼‚å¸¸ï¼‰
- å»ºè®®è°ƒæ•´ï¼ˆé•¿æœŸå¼‚å¸¸ï¼‰

**æ¶ˆæ¯ç¤ºä¾‹**:
```
ä½ å¥½ï¼Œæ³¨æ„åˆ°ä½ å·²ç»3å¤©æ²¡æœ‰å­¦ä¹ äº†ã€‚ğŸ˜”

å¤‡è€ƒè·¯ä¸Šé‡åˆ°å›°éš¾å¾ˆæ­£å¸¸ï¼Œè¦ä¸è¦èŠèŠï¼Ÿ
æˆ‘å¯ä»¥å¸®ä½ ï¼š
- åˆ†æå½“å‰å­¦ä¹ çŠ¶å†µ
- è°ƒæ•´å­¦ä¹ è®¡åˆ’
- æä¾›å¤‡è€ƒå»ºè®®

[èŠèŠçœ‹] [æˆ‘æ²¡äº‹]
```

---

## ğŸ”§ æŠ€æœ¯å®ç°

### æŠ€æœ¯æ ˆ

- node-cron: å®šæ—¶ä»»åŠ¡è°ƒåº¦
- bull: ä»»åŠ¡é˜Ÿåˆ—ï¼ˆRedisï¼‰
- @civil-agent/core: ç±»å‹å®šä¹‰
- @civil-agent/agent-langgraph: Agent å®¢æˆ·ç«¯

### ä»£ç ç»“æ„

```
src/
â”œâ”€â”€ jobs/
â”‚   â”œâ”€â”€ morning-greeting.ts    # æ—©å®‰é—®å€™ä»»åŠ¡
â”‚   â”œâ”€â”€ evening-review.ts      # æ™šé—´å¤ç›˜ä»»åŠ¡
â”‚   â””â”€â”€ anomaly-check.ts       # å¼‚å¸¸æ£€æµ‹ä»»åŠ¡
â”œâ”€â”€ queue/
â”‚   â”œâ”€â”€ bull-queue.ts          # Bull é˜Ÿåˆ—é…ç½®
â”‚   â””â”€â”€ processors.ts          # ä»»åŠ¡å¤„ç†å™¨
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ cron.config.ts         # Cron é…ç½®
â”‚   â””â”€â”€ scheduler.config.ts    # è°ƒåº¦å™¨é…ç½®
â”œâ”€â”€ notification/
â”‚   â””â”€â”€ push-notification.ts   # æ¨é€é€šçŸ¥
â””â”€â”€ index.ts                   # å…¥å£æ–‡ä»¶
```

---

## ğŸ”Œ æ¥å£å®šä¹‰

### ä»»åŠ¡å®šä¹‰

| ä»»åŠ¡åç§° | Cron è¡¨è¾¾å¼ | æè¿° | å¹¶å‘æ•° |
|---------|------------|------|--------|
| morning-greeting | 0 8 * * * | æ—©å®‰é—®å€™ | 10 |
| evening-review | 0 22 * * * | æ™šé—´å¤ç›˜ | 10 |
| anomaly-check | 59 23 * * * | å¼‚å¸¸æ£€æµ‹ | 5 |

### ä»»åŠ¡é˜Ÿåˆ—é…ç½®

```typescript
interface QueueConfig {
  connection: {
    host: string;
    port: number;
    db: number;
  };
  defaultJobOptions: {
    attempts: number;      // é‡è¯•æ¬¡æ•°
    backoff: {
      type: 'exponential';
      delay: number;       // é‡è¯•å»¶è¿Ÿ
    };
    removeOnComplete: boolean;
    removeOnFail: boolean;
  };
}
```

---

## ğŸ“ ä¾èµ–å…³ç³»

### ä¾èµ–çš„æ¨¡å—

- `@civil-agent/core`: ç±»å‹å®šä¹‰
- `@civil-agent/agent-langgraph`: Agent è°ƒç”¨

### å¤–éƒ¨ä¾èµ–

- Redis: ä»»åŠ¡é˜Ÿåˆ—å­˜å‚¨
- æ¨é€æœåŠ¡: å‘é€é€šçŸ¥

---

## ğŸš€ å¼€å‘æŒ‡å—

### æœ¬åœ°å¼€å‘

```bash
# è¿›å…¥ç›®å½•
cd packages/scheduler

# å®‰è£…ä¾èµ–
pnpm install

# å¼€å‘æ¨¡å¼
pnpm dev

# æ„å»º
pnpm build

# å¯åŠ¨è°ƒåº¦å™¨
pnpm start
```

### ç¯å¢ƒå˜é‡é…ç½®

```bash
# .env æ–‡ä»¶
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=

# æ¨é€æœåŠ¡é…ç½®
PUSH_SERVICE_KEY=your_push_service_key
PUSH_SERVICE_URL=https://push.service.com

# è°ƒåº¦å™¨é…ç½®
SCHEDULER_ENABLED=true
SCHEDULER_TIMEZONE=Asia/Shanghai
```

### Redis é…ç½®

```bash
# å¯åŠ¨ Redis
docker run -d -p 6379:6379 redis:alpine

# æˆ–ä½¿ç”¨æœ¬åœ° Redis
redis-server
```

---

## ğŸ“‹ å¾…åŠäº‹é¡¹

- [x] å®ç°æ—©å®‰é—®å€™ä»»åŠ¡ (0.5å¤©)
- [x] å®ç°æ™šé—´å¤ç›˜ä»»åŠ¡ (0.5å¤©)
- [x] å®ç°å¼‚å¸¸æ£€æµ‹ä»»åŠ¡ (0.5å¤©)
- [x] é›†æˆ Bull é˜Ÿåˆ— (0.5å¤©)

---

## ğŸ“š ä½¿ç”¨ç¤ºä¾‹

### å¯åŠ¨è°ƒåº¦å™¨

```typescript
import { Scheduler } from "@civil-agent/scheduler";

const scheduler = new Scheduler();

// å¯åŠ¨æ‰€æœ‰å®šæ—¶ä»»åŠ¡
scheduler.start();

console.log("è°ƒåº¦å™¨å·²å¯åŠ¨");
console.log("- æ—©å®‰é—®å€™: æ¯å¤© 8:00");
console.log("- æ™šé—´å¤ç›˜: æ¯å¤© 22:00");
console.log("- å¼‚å¸¸æ£€æµ‹: æ¯å¤© 23:59");
```

### æ‰‹åŠ¨è§¦å‘ä»»åŠ¡ï¼ˆæµ‹è¯•ç”¨ï¼‰

```typescript
import { morningGreetingJob } from "@civil-agent/scheduler";

// æ‰‹åŠ¨è§¦å‘æ—©å®‰é—®å€™
await morningGreetingJob({
  userId: "user-123"
});
```

### ç›‘æ§ä»»åŠ¡é˜Ÿåˆ—

```typescript
import { Queue } from "bull";

const queue = new Queue("civil-service-tasks");

// æŸ¥çœ‹é˜Ÿåˆ—çŠ¶æ€
const waiting = await queue.getWaiting();
const active = await queue.getActive();
const completed = await queue.getCompleted();
const failed = await queue.getFailed();

console.log("ç­‰å¾…ä¸­:", waiting.length);
console.log("æ‰§è¡Œä¸­:", active.length);
console.log("å·²å®Œæˆ:", completed.length);
console.log("å¤±è´¥:", failed.length);
```

---

## ğŸ“ æœ€ä½³å®è·µ

1. **ä»»åŠ¡å¹‚ç­‰æ€§**: ç¡®ä¿ä»»åŠ¡é‡å¤æ‰§è¡Œä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨
2. **å¤±è´¥é‡è¯•**: åˆç†è®¾ç½®é‡è¯•æ¬¡æ•°å’Œå»¶è¿Ÿ
3. **ç›‘æ§å‘Šè­¦**: ç›‘æ§ä»»åŠ¡æ‰§è¡Œå¤±è´¥ç‡ï¼ŒåŠæ—¶å‘Šè­¦
4. **æ€§èƒ½ä¼˜åŒ–**: é¿å…åœ¨é«˜å³°æ—¶æ®µæ‰§è¡Œå¤§é‡ä»»åŠ¡
5. **æ—¥å¿—è®°å½•**: è¯¦ç»†è®°å½•ä»»åŠ¡æ‰§è¡Œæ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜

---

## ğŸ” è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹ä»»åŠ¡æ—¥å¿—

```bash
# è®¾ç½®æ—¥å¿—çº§åˆ«
LOG_LEVEL=DEBUG pnpm start

# æŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œæ—¥å¿—
tail -f logs/scheduler.log
```

### æŸ¥çœ‹ Bull é˜Ÿåˆ—çŠ¶æ€

```bash
# ä½¿ç”¨ Bull Board ç›‘æ§é˜Ÿåˆ—
pnpm add bull-board

# è®¿é—® http://localhost:3000/bull
```

### æ‰‹åŠ¨è§¦å‘ä»»åŠ¡æµ‹è¯•

```typescript
// æµ‹è¯•æ—©å®‰é—®å€™
await testJob("morning-greeting", {
  userId: "test-user-123"
});

// æŸ¥çœ‹æ‰§è¡Œç»“æœ
console.log("ä»»åŠ¡æ‰§è¡Œå®Œæˆ");
```

---

## ğŸ“Š ä»»åŠ¡æ‰§è¡Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Cron è§¦å‘å™¨                              â”‚
â”‚                  (æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   æ£€æŸ¥æ˜¯å¦åˆ°ç‚¹       â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                     â”‚
           æœªåˆ°ç‚¹                 åˆ°ç‚¹
              â”‚                     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚   æ·»åŠ åˆ° Bull é˜Ÿåˆ—   â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚    Worker å¤„ç†       â”‚
                         â”‚  (å¹¶å‘æ‰§è¡Œ)          â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚   è°ƒç”¨ Agent         â”‚
                         â”‚   ç”Ÿæˆæ¶ˆæ¯           â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚   å‘é€æ¨é€é€šçŸ¥       â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚   è®°å½•æ‰§è¡Œæ—¥å¿—       â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš¨ é”™è¯¯å¤„ç†

### ä»»åŠ¡å¤±è´¥é‡è¯•ç­–ç•¥

```typescript
{
  attempts: 3,              // æœ€å¤šé‡è¯• 3 æ¬¡
  backoff: {
    type: 'exponential',
    delay: 5000            // åŸºç¡€å»¶è¿Ÿ 5 ç§’
  }
}

// é‡è¯•å»¶è¿Ÿè®¡ç®—
// ç¬¬1æ¬¡é‡è¯•: 5 ç§’
// ç¬¬2æ¬¡é‡è¯•: 10 ç§’
// ç¬¬3æ¬¡é‡è¯•: 20 ç§’
```

### æ­»ä¿¡é˜Ÿåˆ—å¤„ç†

```typescript
// è¶…è¿‡é‡è¯•æ¬¡æ•°åè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—
queue.on('failed', (job, err) => {
  if (job.attemptsMade >= job.opts.attempts) {
    // è®°å½•åˆ°æ­»ä¿¡é˜Ÿåˆ—
    deadLetterQueue.add(job.data);
    // å‘é€å‘Šè­¦
    sendAlert(`ä»»åŠ¡å¤±è´¥: ${job.name}`, err);
  }
});
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### æ‰¹é‡å¤„ç†ä¼˜åŒ–

```typescript
// æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·ï¼ˆå‡å°‘æ•°æ®åº“æŸ¥è¯¢ï¼‰
const users = await batchGetUsers(userIds, 100);

// æ‰¹é‡è°ƒç”¨ Agentï¼ˆå‡å°‘ HTTP è¯·æ±‚ï¼‰
const results = await batchCallAgent(users, 10);
```

### Redis è¿æ¥æ± 

```typescript
{
  connection: {
    host: 'localhost',
    port: 6379,
    maxRetriesPerRequest: 3,
    enableReadyCheck: true,
    maxRetriesPerRequest: null
  }
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-01-23
**ç»´æŠ¤è€…**: sxh
